<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>파일 업로드 테스트</title>

	<style>
		.progress {height: 10px;}
		.progressContainer{position:relative;width: 450px;padding:20px 10px;margin-top: 15px;height:10px;}
		.progress{position:absolute;width: calc(100% - 20px);height: 10px;}
		.progressTotal{background: rgba(80,90,100,0.15);border-radius: 10px;}
		.progressNow{width: calc(0% - 20px);background: #057FEB;border-radius: 10px;}
		.progressPer{background: transparent; text-align:center;color:#A6A6A6;}
		.progressText{position: absolute; right: 0; top: 50%; transform: translate(100%, -50%)}
	</style>
</head>
<body>
	<form>
		<input type="file" name="file" multiple>
		<button type="button" id="btn">전송</button>
	</form>

	<div class="inner"></div>
	
	<script>
		(() => {
				const $ = (select) => document.querySelector(select)

				const progressBar = (per, size) => {
					let i = new Array();
					// $(".progressText").innerText = Math.floor(per)+" %";
					// $(".progressNow").style.width = "calc(" + per + "% - 20px)";

					const template = size.map((item) => {
						return `
							<div class="progressContainer">
								<div class="progress progressTotal"></div>
								<div class="progress progressNow" style="width:calc(${per}% - 20px)"></div>
								<div class="progressText">${per}</div>
							</div>
						`
					}).join('');
					$('.inner').innerHTML = template;
				};

				const xhrFun = (e) => {
					e.preventDefault();
					let sizeArr = new Array();
					const xhr = new XMLHttpRequest();

					xhr.upload.addEventListener('loadstart', function(e) {
						console.log('시작')
					});
					/*
						progress 이벤트 핸들러는
						전송할 총 바이트 수 total과 이벤트 및 loaded 필드에서 지금까지 전송 된 바이트 수를 받습니다.
					*/
					xhr.upload.addEventListener('progress', function(e) {
						if( e.lengthComputable ) {
							// 업로드 진행률 계산
							const percentComplete = Math.floor((e.loaded / e.total) * 100); 
							progressBar(percentComplete, sizeArr)
						} else {
							// 측정 불가
						}

						
					});
					xhr.upload.addEventListener('load', function(e) {
						
					});
					xhr.upload.addEventListener('loadend', function(e) {
						console.log('완료')
					});

					xhr.upload.addEventListener('error', function(e) {
						console.log('요청이 실패했을 때')
					});
					xhr.upload.addEventListener('abort', function(e) {
						console.log('요청이 중단되었을 때')
					});
					xhr.upload.addEventListener('timeout', function(e) {
						console.log('요청이 완료되기 전에 작성자가 지정한 타임아웃이 지났을 때')
					});

					xhr.open('POST', '/file/upload-file', true);
					// xhr.open('POST', '/upload-file', false);  //false로 하면 동기 처리

					xhr.addEventListener('readystatechange', function (event) {
						const { target } = event; 
						if (target.readyState === XMLHttpRequest.DONE) { 
							const { status } = target; 
							if (status === 0 || (status >= 200 && status < 400)) {
								// 요청이 정상적으로 처리 된 경우 } 
								console.log(target.response);
							} else {
								// 에러가 발생한 경우 
							} 
						};
					});

					const files = $('input[name=file]').files;
					const filesArr = Array.prototype.slice.call(files);
					for(let i = 0; i <= filesArr.length; i++){
						const el = filesArr[i];
						console.log(String(el.size))
						sizeArr.push(String(el.size))
					};
					const formData = new FormData();
					xhr.send(formData);
				};

				$('#btn').addEventListener('click', xhrFun);
		})()
	</script>
</body>
</html>